sequenceDiagram
    autonumber
    participant U as ðŸ“± User
    participant App as Flutter App
    participant API as Express API
    participant HF as HuggingFace BERT
    participant TRM as TRM Algorithm
    participant EGP as EGP Algorithm
    participant Gemini as Google Gemini
    participant DB as MongoDB
    
    U->>App: Types message
    App->>API: POST /chat/message
    API->>API: Authenticate JWT
    API->>HF: Send text for emotion detection
    HF-->>API: Return emotion probabilities
    API->>API: Enrich emotion metadata
    API->>TRM: Map emotion to therapeutic strategy
    TRM-->>API: Return response strategy
    API->>EGP: Build emotion-aware prompt
    EGP-->>API: Return structured prompt
    API->>Gemini: Generate response with prompt
    Gemini-->>API: Return AI response
    API->>DB: Store message + emotion data
    DB-->>API: Confirm storage
    API-->>App: Return response + emotionData
    App->>App: Display response with emotion badge
    App-->>U: Show AI response
